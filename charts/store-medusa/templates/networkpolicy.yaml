{{/*
NetworkPolicies for store isolation.

Defense-in-depth model:
  1. Default deny ALL ingress
  2. Allow ingress controller → storefront + medusa-backend
  3. Allow storefront → medusa-backend (internal proxy)
  4. Allow medusa-backend → postgres (database access)

The ingress controller label is configurable via values to support:
  - Nginx (Kind/local):   app.kubernetes.io/name: ingress-nginx
  - Traefik (k3s/prod):   app.kubernetes.io/name: traefik
*/}}

{{- if .Values.networkPolicy.enabled }}
# --- Default deny all ingress ---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  labels:
    {{- include "store-medusa.labels" . | nindent 4 }}
spec:
  podSelector: {}
  policyTypes:
    - Ingress
---
# --- Allow ingress controller → storefront + medusa-backend ---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-to-services
  labels:
    {{- include "store-medusa.labels" . | nindent 4 }}
spec:
  podSelector:
    matchExpressions:
      - key: app.kubernetes.io/name
        operator: In
        values: ["storefront", "medusa-backend"]
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              {{- toYaml .Values.networkPolicy.ingressControllerSelector | nindent 14 }}
      ports:
        - port: 8000
          protocol: TCP
        - port: 9000
          protocol: TCP
---
# --- Allow storefront → medusa-backend ---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-storefront-to-medusa
  labels:
    {{- include "store-medusa.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: medusa-backend
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: storefront
      ports:
        - port: 9000
          protocol: TCP
---
# --- Allow medusa-backend → postgres ---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-medusa-to-postgres
  labels:
    {{- include "store-medusa.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: postgres
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: medusa-backend
      ports:
        - port: 5432
          protocol: TCP
{{- end }}
